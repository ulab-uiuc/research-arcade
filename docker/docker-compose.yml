version: '3.8'

services:
  crawler-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: research-arcade-crawler
    restart: unless-stopped
    environment:
      # Database configuration
      - DB_TYPE=${DB_TYPE:-csv}
      - CSV_DATASET_FOLDER_PATH=${CSV_DATASET_FOLDER_PATH:-/app/data/csv}
      
      # SQL configuration (if using SQL)
      - HOST=${HOST:-postgres}
      - PORT=${PORT:-5432}
      - DBNAME=${DBNAME:-research_arcade}
      - USER=${USER:-postgres}
      - PASSWORD=${PASSWORD}
      
      # Crawler configuration
      - DOWNLOAD_PATH=${DOWNLOAD_PATH:-/app/download}
      - CRAWL_INTERVAL=${CRAWL_INTERVAL:-5}
      
      # Scheduler configuration
      - SCHEDULE_TYPE=${SCHEDULE_TYPE:-interval}
      - RUN_EVERY_DAYS=${RUN_EVERY_DAYS:-5}
      - CRAWL_HOUR=${CRAWL_HOUR:-2}
      - CRAWL_MINUTE=${CRAWL_MINUTE:-0}
      - RUN_ON_STARTUP=${RUN_ON_STARTUP:-true}
    volumes:
      # Persist downloaded papers
      - ./data/download:/app/download
      # Persist CSV data (if using CSV)
      - ./data/csv:/app/data/csv
      # Persist logs
      - ./logs:/app/logs
    depends_on:
      - postgres
    networks:
      - research-arcade-network

  postgres:
    image: postgres:15-alpine
    container_name: research-arcade-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${DBNAME:-research_arcade}
      - POSTGRES_USER=${USER:-postgres}
      - POSTGRES_PASSWORD=${PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${PORT:-5432}:5432"
    networks:
      - research-arcade-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:

networks:
  research-arcade-network:
    driver: bridge